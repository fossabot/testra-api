package tech.testra.reportal.api.rest.handlers

import org.springframework.http.MediaType
import org.springframework.http.MediaType.APPLICATION_JSON_UTF8
import org.springframework.stereotype.Component
import org.springframework.web.reactive.function.BodyInserters.fromObject
import org.springframework.web.reactive.function.BodyInserters.fromPublisher
import org.springframework.web.reactive.function.server.ServerRequest
import org.springframework.web.reactive.function.server.ServerResponse
import org.springframework.web.reactive.function.server.ServerResponse.created
import org.springframework.web.reactive.function.server.ServerResponse.noContent
import org.springframework.web.reactive.function.server.ServerResponse.ok
import reactor.core.publisher.Mono
import reactor.core.publisher.toMono
import tech.testra.reportal.api.rest.extensions.executionId
import tech.testra.reportal.api.rest.extensions.projectId
import tech.testra.reportal.api.rest.extensions.resultId
import tech.testra.reportal.domain.entity.VulnerabilityAlert
import tech.testra.reportal.exception.TestResultNotFoundException
import tech.testra.reportal.model.VulnerabilityAlerts
import tech.testra.reportal.service.interfaces.IVulnerabilityAlertService

@Component
class VulnerabilityHandler(val vulnerabilityAlertService: IVulnerabilityAlertService) {

    fun findAll(req: ServerRequest): Mono<ServerResponse> =
        ok().contentType(APPLICATION_JSON_UTF8)
            .body(fromPublisher(vulnerabilityAlertService.getVulnerabilityAlertByProjectAndExecutionId(req.projectId(),
                req.executionId()), VulnerabilityAlert::class.java))

    fun create(req: ServerRequest): Mono<ServerResponse> =
        vulnerabilityAlertService.createVulnerabilityAlert(req.projectId(), req.executionId(), req.bodyToMono(VulnerabilityAlerts::class.java))
            .flatMap { created(req.uri()).contentType(MediaType.APPLICATION_JSON_UTF8).body(fromObject(it)) }

    fun delete(req: ServerRequest): Mono<ServerResponse> =
        vulnerabilityAlertService.getVulnerabilityAlertById(req.projectId(), req.executionId(), req.resultId())
            .switchIfEmpty(TestResultNotFoundException(req.resultId()).toMono())
            .flatMap { noContent().build(vulnerabilityAlertService.deleteVulnerabilityAlertById(req.resultId())) }
}